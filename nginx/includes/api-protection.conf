# API Protection Configuration (Include File)
#
# This file contains comprehensive API endpoint protection including:
# - JWT authentication validation
# - Rate limiting per IP address
#
# Usage:
#   location /api/v1/resource {
#       include includes/api-protection.conf;
#       # ... rest of location config
#   }
#
# What this does:
# 1. Makes subrequest to Token Validation Service for JWT validation
# 2. Extracts user ID from validated JWT for backend services
# 3. Applies rate limiting per IP address (100 req/min)

# Validate JWT via Token Validation Service
auth_request /auth/validate;

# Extract user ID from validated JWT (set by Token Validation Service in X-JWT-User-Id header)
auth_request_set $jwt_user_id $upstream_http_x_jwt_user_id;

# Rate limiting: 100 requests per minute per IP address (configurable burst)
# Customize burst parameter in individual location blocks if needed
limit_req zone=per_ip burst=20 nodelay;
limit_req_status 429;
