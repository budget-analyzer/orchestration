version: '3.8'

services:
  claude-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: vscode
        USER_UID: 1002
        USER_GID: 1002
        DOCKER_GID: 986
    
    volumes:
      # Mount dev directory as workspace (read/write)
      - ../../:/workspace:cached

      # Mount claude-code-sandbox as read-only (security: Claude Code cannot modify its own config)
      - .:/workspace/orchestration/claude-code-sandbox:ro

      # Persistent storage for Claude Code credentials
      - claude-anthropic:/home/vscode/.anthropic

      # Mount Docker socket for Testcontainers (docker-outside-of-docker pattern)
      - /var/run/docker.sock:/var/run/docker.sock
    
    # Use host network for simplicity
    network_mode: host

    # Environment variables for Testcontainers
    environment:
      # Required for Docker Desktop compatibility (allows containers to reach host)
      - TESTCONTAINERS_HOST_OVERRIDE=host.docker.internal

    # Keep container running
    command: sleep infinity

    user: vscode

volumes:
  claude-anthropic:
